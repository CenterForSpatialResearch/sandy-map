var coastMap = {
  v: {
    noverlap: {
      tolerance: .3,
      maxRadius: 175
    },
    photoDims: { x: 750, w: 360, h: 239, l: 18 },
    photoLocations: [],
    ny: {
      width: 1150, height: 3550,
      // projection properties
      translateX: -305171, translateY: 265987, center: [0,41.16], rotate: [210,0], scale: 247000,
      //data locations
      dataSource: {
        coast: "data/ny_coast.json", 
        tracts: "data/ny_tracts.json", 
        damage: "data/ny_damage.json", 
        photos: "data/ny_photos.json",
        photosPath: "data/photos/ny/ny_lightbox/",
        aggregateDamage: [[324.6886824314687,2842.426547060858,56.99999999999998,361],[128.59983141929843,3397.846529308823,3,1],[442.2739536122831,2749.8992644214954,122.44998979175138,1666],[410.081880316684,1883.0053878230271,167.1406593262086,3104],[256.3877487208083,1045.1458375511138,5.999999999999999,4],[-396.0426796664827,3035.7082625368935,104.61357464497662,1216],[310.2910578037959,3325.572557081566,135.2996674053559,2034],[259.4128666848552,1658.742249510288,53.24471804789652,315],[421.46561314525593,2015.6039263623672,78.9176786277952,692],[334.54815357893796,2984.158949492708,58.86425061104568,385],[396.44710882534116,215.67474181799562,65.1766829472013,472],[813.1807218380997,3641.8077591754077,49.11211663123472,268],[225.4160189881481,988.917008834186,9,9],[555.812114913184,3839.313275312079,19.20937271229855,41],[188.63383376040596,2158.650125346161,32.726136343907115,119],[311.1616597947286,2410.4037495759094,96.04686356149254,1025],[233.11371336056618,983.2149640501011,3,1],[242.92929959693575,974.7810932844004,9.486832980505136,10],[216.5543273940302,929.6524499646674,31.176914536239796,108],[388.91254852471826,2484.7685581929945,20.12461179749811,45],[248.00024434344598,1925.3512706401054,22.64950330581225,57],[319.8807010301497,2764.750357515811,24.186773244895654,65],[300.0803979686578,1685.2557438711751,6.7082039324993685,5],[410.69145402006427,2144.6302661110212,9.949874371066198,11],[413.3967391165157,315.02067180964985,43.47413023856832,210],[297.60889853083063,1640.5771363129606,3,1],[379.56531384499976,88.56687099533156,3,1],[379.7088845387334,80.47131821064977,3,1],[378.69571754336886,143.4595986052988,9.949874371066198,11],[360.2057707461645,710.4978309446984,8.999999999999998,9],[260.2942174312775,1701.119059028104,3,1],[413.3940366759198,363.7122948462493,3,1],[385.792818224623,2164.694033715017,7.937253933193771,7],[297.65799562097527,2789.8642186812067,4.242640687119285,2],[228.84344963936599,1137.9016218359932,11.61895003862225,15],[34.837454377731774,2450.265479927999,4.242640687119285,2],[713.7382516327913,3904.8173294198477,17.748239349298846,35],[425.791307604115,363.7673739339807,4.242640687119285,2],[514.6770195463323,3699.402113304745,5.196152422706631,3],[202.8606139748105,868.3350340508623,12.727922061357855,18],[386.8560024787439,2443.0365808269125,3,1],[214.1614544991268,961.8321583458843,7.348469228349534,6],[50.852397627575556,2449.68244887772,4.242640687119285,2],[-694.4988116436289,2274.323438861291,3,1],[328.63613606482977,3561.8849708579946,3,1],[-110.18831164890435,-1811.8721403554082,3,1],[423.69340698394814,2091.4008443797516,15.297058540778355,26],[852.252816056367,3814.384486577648,3,1],[65.84493551051352,2433.447656976751,18.7349939951952,39],[365.97809542139294,3831.539236582641,3,1],[424.42852172855055,354.2569612142106,4.242640687119285,2],[-724.0311864729738,2268.2136330698268,3,1],[-116.40576542317609,-1830.9272983589844,8.999999999999998,9],[837.690488570755,3751.2077499666125,10.816653826391967,13],[200.72958120787516,893.4536776948371,6.7082039324993685,5],[170.4942123867222,782.7962845914008,4.242640687119285,2],[518.235522993394,3681.8646715783784,5.196152422706631,3],[203.64440656325314,1609.6728116726154,3,1],[180.4257343164645,768.3461800374789,3,1],[248.22276268069982,1050.771372149553,4.242640687119285,2],[50.75782731757499,-846.9858959799167,3,1],[504.46857993194135,3703.6925037433393,3,1],[398.1449090767963,2549.0548357772263,35.11409973215887,137],[486.43260623380775,3862.305012951605,3,1],[348.0961561725708,2925.9398459298827,5.999999999999999,4],[480.03395240660757,3844.8912332389737,3,1],[232.6168403250049,1878.5820906258014,4.242640687119285,2],[342.46463614606904,2276.8695242009894,24.919871588754226,69],[355.70139191753697,2296.103197797842,4.242640687119285,2],[187.9748941861811,898.3461774748284,7.348469228349534,6],[193.89295851058267,821.8356118400698,13.416407864998739,20],[207.4023274462088,1048.8733842218062,3,1],[199.41739988673362,1081.1091062058404,4.242640687119285,2],[176.84951382310828,899.0595078609767,3,1],[176.26355060678907,905.3668517687474,3,1],[191.855044027674,1081.0262953501078,3,1],[896.8645743454377,3402.991141460646,15.297058540778355,26],[495.01590171590215,3625.8604675424285,3,1],[324.96934545002875,2907.219467892777,6.7082039324993685,5],[416.17885999474674,4028.5244480876718,3,1],[235.5631071314565,1086.5846569067799,3,1],[214.60151574690826,871.1113687751349,3,1],[197.1454226525966,1876.6590083900082,4.242640687119285,2],[238.1796624728595,1884.0066414100002,3,1],[123.86968643256115,3207.4099777419347,11.224972160321823,14],[387.13913281960413,2453.2800326152355,3,1],[-17.89338538007966,3510.451296021269,5.196152422706631,3],[240.7956992171239,1149.4686971785268,3,1],[161.1629843133851,771.1275236541904,7.937253933193771,7],[311.0085773456958,2227.710893154843,3,1],[-232.4229495082982,2707.1295108833583,3,1],[167.8563530629035,776.7472142144106,3,1],[346.48874912462713,2911.6239911946727,8.999999999999998,9],[334.5349107508373,2911.9322193021944,4.242640687119285,2],[844.3988532439301,3790.970596196214,9,9],[255.5544828894781,1960.61002403748,3,1],[153.94669314378794,3192.619434868878,5.196152422706631,3],[8.441087649844121,3597.821551566507,5.999999999999999,4],[411.60861801338615,280.10631050437223,3,1],[27.80082518584095,3601.017323135806,3,1],[244.18709240382304,1754.970245582168,3,1],[302.79468485928373,2245.555521332484,3,1],[247.4613753780972,1367.1872583382396,7.937253933193771,7],[-94.69159860932851,3012.390737294109,9.486832980505138,10],[315.16597888903925,3053.795173781633,3,1],[212.00806733127683,1186.7596932545653,6.7082039324993685,5],[221.2145306548773,1193.8968246365403,5.999999999999999,4],[-15.725630070560147,-903.3044470236171,9.486832980505138,10],[264.8870268095052,1471.9294450405093,7.348469228349534,6],[191.43937379535055,1143.122410604934,4.242640687119285,2],[166.51051879057195,756.0153736322536,3,1],[268.3556662305491,1484.1125255026855,5.196152422706631,3],[250.99889422109118,1488.326053136785,3,1],[247.92026193387574,1496.7563508122112,3,1],[360.82601578184403,2314.619039114652,4.242640687119285,2],[357.38521040440537,2116.2496705861217,5.196152422706631,3],[236.60719134521787,1607.725715648412,4.242640687119285,2],[188.2513808668009,3661.642433142115,3,1],[410.91710513019643,268.1062143266826,8.48528137423857,8],[-688.7621200124559,3071.7092809675087,4.242640687119285,2],[310.0716301490087,-229.0186376083875,6.7082039324993685,5],[483.9719995969984,3598.557968933077,5.196152422706631,3],[258.76108641084284,1158.5458634674433,4.242640687119285,2],[313.993367174553,3042.0517513023224,4.242640687119285,2],[379.56942876428366,2371.1260337548447,3,1],[341.5833106509235,702.2002124748833,4.242640687119285,2],[203.47892237550113,1268.5567954715807,6.7082039324993685,5],[237.9446364964242,1552.6740507752402,3,1],[-884.9584011517582,1371.3539798981594,7.937253933193771,7],[246.56113662747111,1099.8896758320952,14.387494569938161,23],[-88.71435076132184,-1112.2215197014739,3,1],[-826.0459455755902,2997.7728981387563,12.727922061357855,18],[238.28481685422594,1596.634358793206,3,1],[-86.0956470821402,2945.9292913360405,3,1],[-89.02360147508443,-1158.2764541413635,4.242640687119285,2],[546.0682709261309,3799.769640377199,3,1],[303.0605265332706,2213.0507502411347,5.999999999999999,4],[7.213897043780889,2800.1766512434697,3,1],[242.09798214043258,1294.3801263709709,5.196152422706631,3],[534.8047332848946,3781.351340032372,5.999999999999999,4],[219.74070656538242,1271.047374054906,4.242640687119285,2],[225.8806217586971,1272.0979446944548,3,1],[839.5364385095309,4277.959680270462,3,1],[267.52545716524764,1525.3991151704395,5.999999999999999,4],[9.541004489583429,-1292.9742273589363,3,1],[243.20905032453206,1356.1536870957545,5.196152422706631,3],[356.2254148859356,2250.189103117882,7.348469228349534,6],[350.5188209543703,2900.9155243309797,4.242640687119285,2],[354.2531703386194,2238.6896947433124,5.999999999999999,4],[-82.55408675270155,-1309.8257971852436,3,1],[81.34907075722003,514.4207915454754,3,1],[258.62063207439496,1234.9628886409046,4.242640687119285,2],[196.82441639428725,1285.6118156805169,3,1],[358.0595752930385,2258.9550392612,3,1],[342.82234278763644,2236.557896078506,3,1],[365.1127183447825,2233.3723540989595,5.999999999999999,4],[271.11931149325875,2209.2303238358386,5.196152422706631,3],[-828.0659007334616,2971.9474497350748,3,1],[355.6614606354735,743.0335940557532,6.7082039324993685,5],[232.78142526035663,1885.9212991216336,3,1],[39.79122401442146,2471.962233885308,3,1],[184.31606491484368,808.0563652204388,7.348469228349534,6],[-552.5213190198992,3307.4989214850357,3,1],[845.9688506742677,3766.531604032876,8.48528137423857,8],[970.1275047488816,3305.6623980985896,8.48528137423857,8],[-765.2186937349034,3142.960918911791,3,1],[408.7418115806132,3493.301747976052,8.999999999999998,9],[398.86755343020195,2518.8284653466835,4.242640687119285,2],[447.9851820928161,2651.9668866990833,3,1],[415.7301067692024,2575.442065216994,5.999999999999999,4],[-424.69187052798225,3371.4512003123527,3,1],[978.0240769737284,3292.901548153682,5.196152422706631,3],[702.2005710923113,3952.3294118614285,3,1],[-78.91387816865851,3529.513766246712,5.196152422706631,3],[-800.6351996656158,2747.890940006124,3,1],[-766.0935827928479,3044.430919939987,5.999999999999999,4],[-931.7110109407222,2666.9538295947714,3,1],[-944.635222444078,2663.039640231,3,1],[256.1636021231534,1144.5836335587082,3,1],[432.5431483195862,3510.7035715099773,3,1],[237.72167495416943,3656.443129236053,3,1],[905.7878367156283,3458.1477087102785,10.816653826391967,13],[962.7867111342784,3330.3438204536214,4.242640687119285,2],[912.2130551920272,3725.191186744545,3,1],[227.64325457811356,2142.530726885074,3,1],[-9.955028559430502,3504.9925638751592,3,1],[113.93142076965887,3213.090143801004,3,1],[325.033218514733,3039.4331075260648,6.7082039324993685,5],[968.5742296852113,3323.6851707448077,4.242640687119285,2],[744.3027941450127,4026.8107553729205,3,1],[209.9495793756214,2143.610154164664,3,1],[334.78263133508153,3048.7922944683232,3,1],[427.1743880296126,2569.6015911590657,3,1],[755.5320827162941,3873.490427481476,3,1],[105.73239465689403,3220.9296618665394,4.242640687119285,2],[601.6993783597718,3967.2302787596127,3,1],[376.977907547669,3868.50674873119,3,1],[85.51299129764084,3224.0610287021846,3,1],[-746.275730841473,3040.6650910523313,4.242640687119285,2],[-752.3987929796567,3039.659330266237,3,1],[-860.9245519651449,2968.7805278274755,4.242640687119285,2],[432.2972505527723,2584.0157584272965,4.242640687119285,2],[363.6234458745457,2168.8681657671696,4.242640687119285,2],[69.99333022230505,503.0999399765611,7.937253933193771,7],[195.8857752144104,1431.4695308870287,3,1],[524.951951015275,3910.3152363923145,3,1],[217.70687696072855,1116.0075954668573,4.242640687119285,2],[-708.2371889980277,2793.2099077080493,3,1],[-809.9551256485283,3142.8771352638723,3,1],[152.7797097209259,746.1498491526581,3,1],[476.73896236281144,3584.993802775629,4.242640687119285,2],[883.1197715357412,3402.915875697043,3,1],[-817.0130930496962,3068.296012509265,3,1],[354.79161537025357,2182.284275180835,3,1],[-752.8437097877904,3059.0364658743347,5.999999999999999,4],[-765.0805373291951,27.67516956035979,3,1],[130.99045919417404,3679.936490742839,3,1],[-4.691940829739906,3304.121890125738,3,1],[-337.4936418434954,3267.1009006497334,3,1],[214.11158454226097,3725.665808580874,3,1],[706.8065226310282,3929.0193387250183,3,1],[-1000.5266670514247,2960.6495806895546,3,1],[326.6876144062844,2095.829192562611,3,1],[-854.2827024311409,2952.4757771365694,3,1],[247.12814230444687,1009.8420581748748,5.196152422706631,3],[252.31708038947545,990.7023036209866,7.348469228349534,6],[212.30374426825438,1266.6804614378489,3,1],[253.19356819085078,979.7231094247545,3,1],[-549.5077274071518,1726.1022223592154,3,1],[237.3976565732155,1280.1961825581384,3,1],[250.87812529498478,1348.4674194860272,3,1],[241.6603080505738,985.3794769938104,3,1],[-110.58064913840252,2990.8380304264147,23.430749027719962,61],[211.5514254916343,1121.0548312407918,3,1],[-183.89595472230576,2861.266075436899,3,1],[237.7612416796619,1052.8774401231785,3,1],[277.5886865071516,2965.1851990628347,5.999999999999999,4],[-207.5421806127415,2913.187145134667,3,1],[193.4669893941027,1453.1588384020724,3,1],[236.59955563538824,1061.7558651764994,4.242640687119285,2],[176.7196689338307,2993.387254838948,3,1],[-205.3008499792777,2839.242245557776,3,1],[287.63526202517096,2961.800192311348,3,1],[-847.8324085903005,2958.0786141432473,3,1],[230.47579957108246,1069.3550192800467,3,1],[-259.1692009614344,2783.492946921826,8.48528137423857,8],[808.921538538998,3772.295228932402,3,1],[802.0513459090726,3772.1760804573423,3,1],[915.3879513331922,3369.57122639491,3,1],[200.89903185656294,1321.7103486399283,3,1],[-196.83445301721804,2856.3859698790475,3,1],[348.5861522909836,2893.5932061359053,4.242640687119285,2],[-292.0522430675919,2708.2226215266273,3,1],[338.175963623391,2917.894085751497,3,1],[-220.30889120540814,2842.0871335961856,3,1],[187.0144339549006,1337.8250147763174,3,1],[-1203.5304276600364,1902.599483715545,3,1],[853.4410214128438,3804.040412012313,3,1],[197.66604112792993,954.7509149074613,4.242640687119285,2],[210.65930045285495,1312.8390117044328,3,1],[-708.4589182913769,1172.5584434302873,3,1],[859.33750488368,3457.8521056054255,10.392304845413264,12],[238.96065997693222,3258.1498373321374,3,1],[896.380765404785,3388.7868529034895,3,1],[907.9022669219412,3433.1975716272427,4.242640687119285,2],[260.51530213007936,3009.5842706756084,5.196152422706631,3],[505.6341829271405,3664.020315170288,3,1],[-1.1898061221290845,3457.9167685886496,5.999999999999999,4],[433.4354984415113,2649.0094388391008,3,1],[485.68293292139424,3612.263343266328,3,1],[289.96071160325664,2881.8736555825453,4.242640687119285,2],[284.6628997872467,2876.6229555010214,4.242640687119285,2],[251.9325687904493,1750.029057611886,3,1],[251.9304655425367,3013.555915314937,3,1],[184.10605192097137,1486.6546530016058,4.242640687119285,2],[296.5061970776296,2877.865715412423,3,1],[846.7339126543375,3808.590771500021,3,1],[-70.65124747355003,2983.428343955311,3,1],[864.8166393277352,3441.45790223754,3,1],[-208.24144633603282,2854.3793536754674,3,1],[313.5367124515469,3025.135954803438,3,1],[-372.3058706555166,2926.9482670137077,3,1]]
      }
    },
    nj: {
      width: 1150, height: 3775,
      // projection properties
      translateX:  -62242, translateY: -31, center: [0,41.16], rotate: [87,0], scale: 366120,
      //data locations
      dataSource: {
        // coast: "data/nj_coast.json",
        tracts: "data/nj_tracts.json",
        damage: "data/nj_damage.json",
        photos: "data/nj_photos.json",
        photosPath: "data/photos/nj/nj_lightbox/",
        aggregateDamage: [[313.547052088255,552.4827058995572,78.91767862779542,692],[258.610250996653,1932.2423073948057,10.816653826391967,13],[371.7511693822438,1075.7961745304115,6.7082039324993685,5],[390.7405588441543,1941.228475451151,11.61895003862225,15],[405.64698224689465,693.8759710350311,12.727922061357853,18],[66.72377067860725,3482.1344173105317,4.242640687119285,2],[329.0882770639364,3580.5027070198557,3,1],[421.95878174772224,1093.6909748474718,3,1],[430.5214968591623,917.8955457602599,9.486832980505138,10],[198.50195976231043,2826.212149334111,3,1],[395.2888405093254,1926.5354182757146,3,1],[330.42909128452084,3239.267334066483,9.486832980505138,10],[208.5868278814465,2818.5048025003284,6.7082039324993685,5],[347.349753388122,2450.1426395002977,47.906158268013954,255],[421.11664761330024,1051.864291775367,54.24942396007535,327],[331.9526517990656,3220.5383539316304,6.7082039324993685,5],[300.9173390070682,3474.612198185648,83.24662155306959,770],[372.37833836652135,1166.8447933048883,3,1],[330.4878606943603,3208.267195931534,4.242640687119285,2],[333.66751506693254,3179.368791068167,5.196152422706631,3],[411.7082949381628,819.4270466828435,37.7094152699296,158],[334.31691050440713,3171.77263074214,3,1],[434.3753639492182,983.226621669916,7.348469228349534,6],[340.81085908957175,1065.7275061658293,3,1],[340.68428497660267,2809.010840962482,12.369316876852979,17],[352.5240728968929,2747.7310395969544,3,1],[361.33033802902355,2498.608918568721,5.196152422706631,3],[408.87474768787104,1126.8340952348049,15.588457268119896,27],[327.4955308893841,3228.300591327017,3,1],[427.2413622033746,787.5845876714739,5.999999999999999,4],[440.3291923827055,1478.349936431332,3,1],[444.9275069830995,1464.7857482644565,7.348469228349534,6],[452.3915016523024,1392.704910496337,3,1],[253.91883653382763,517.665349784013,8.999999999999998,9],[79.771232259518,3550.1268290017324,3,1],[329.55890436912887,3284.4204472994898,3,1],[232.68915681801445,2807.848845016706,3,1],[19.1145361659801,2543.81644079322,3,1],[354.85350875261975,1042.3445516691936,5.999999999999999,4],[245.32764785445397,2813.1466014441976,4.242640687119285,2],[92.13192492364033,3437.102906215092,3,1],[354.6700014202215,2078.99172939884,3,1],[294.0080356288551,3170.660462427215,5.196152422706631,3],[423.36299138540926,771.763651574176,3,1],[405.69133146105014,1973.4347255985776,3,1],[396.4078380884821,1879.701382556901,3,1],[210.7795403394921,3056.4270475375815,3,1],[95.31105140422854,3568.6388387190964,7.348469228349534,6],[341.72083776509265,2529.597497983441,7.937253933193771,7],[343.74784862897906,2569.8944149106187,15.588457268119898,27],[335.9798992545984,2515.8927999358275,4.242640687119285,2],[306.5206814896701,3229.213332870051,5.999999999999999,4],[48.50890367177999,3789.0571338215523,4.242640687119285,2],[376.8161297007973,2001.370069969329,3,1],[288.1803521456681,740.5951563463356,13.747727084867519,21],[427.0736384867271,1148.1839580320566,15.588457268119894,27],[67.58832931000507,3500.3965655809443,3,1],[44.110106951637135,3774.0372294117115,3,1],[-213.6170753249462,2659.497199706675,3,1],[37.482914097888475,3795.104546016548,5.196152422706631,3],[355.08154024576515,2541.050055817653,12.36931687685298,17],[337.56426924122206,2685.8238615389564,3,1],[35.314634288348316,3774.4182437511336,3,1],[26.30650638403131,3796.7735805824486,5.999999999999999,4],[96.63061417882818,3522.2779791378925,5.999999999999999,4],[349.00804210009227,2863.103156042262,9.486832980505138,10],[300.4220425525705,3364.620534991593,11.61895003862225,15],[331.8763872566997,3586.7971675060107,3,1],[331.65905738311267,3538.8725861461135,3,1],[351.72669956044774,2680.3677107849726,5.999999999999999,4],[60.377072038449114,3897.2782790522324,3,1],[57.903665151650785,3883.364900359942,3,1],[330.8343703621789,3133.5659396453866,35.623026261113736,141],[340.2666687919318,2740.5704147736324,5.999999999999999,4],[282.85682691895636,2933.5099437893564,5.196152422706631,3],[296.2912930089842,2923.2034932386014,4.242640687119285,2],[343.16067513996813,2912.565109649444,19.672315572905998,43],[28.563475890725385,3909.2339134784706,3,1],[323.5687241501946,3273.7044369661016,3,1],[440.1436454247523,1516.2943981284334,3,1],[297.58738325964805,3235.2229117972456,4.242640687119285,2],[349.035544482581,2842.0119190669348,9.949874371066198,11],[27.559890616917983,3884.983496247063,3,1],[383.4275667763897,2072.3692150529414,9.486832980505138,10],[57.39646714828632,3871.9120982558525,4.242640687119285,2],[107.11854877344012,3516.604528327065,3,1],[353.6744646159241,754.8143520609301,4.242640687119285,2],[70.73912840810293,3873.090376787792,9.9498743710662,11],[395.71677364360755,966.0972462803164,11.61895003862225,15],[257.2540128720211,2814.759040535224,3,1],[306.5046871731938,3159.9797798646396,5.999999999999999,4],[434.5879265695039,1182.639117864368,3,1],[334.31537913007196,3597.4619266818045,3,1],[167.89329146937962,3093.6109320067335,3,1],[46.84258887873875,3689.7515579729807,3,1],[-69.32538187065802,3235.0314585840097,3,1],[437.21104176192654,1170.9674442296216,11.224972160321823,14],[156.56455757251388,3097.364956435282,3,1],[3.0701523927433305,3218.2467710222118,6.7082039324993685,5],[148.9953279371839,3095.965912382555,3,1],[377.9352902873725,1047.511201271569,4.242640687119285,2],[301.87877873117395,3352.8901401218027,3,1],[371.7871252892219,807.8670771981706,3,1],[301.6355801478785,3346.7315296876477,3,1],[5.519438168186753,3689.8036144345533,3,1],[-48.11955318861146,3243.7374505519983,3,1],[443.6585971921886,990.4513844103494,3,1],[194.11795609667752,666.9773523976619,3,1],[298.56001888428,865.583309724956,3,1],[303.8319961471047,2438.5994128530497,6.7082039324993685,5],[292.1448900842279,2469.353883205302,5.999999999999999,4],[-37.09397063622419,482.40232132187157,8.48528137423857,8],[348.66455120096464,2826.5124353180745,7.937253933193771,7],[331.5502774649867,2817.745918679051,3,1],[304.2492370052132,3661.6020969212987,3,1],[339.4746300799379,2847.021585851413,3,1],[354.66384236010344,2724.0072123177524,4.242640687119285,2],[285.1533726531674,3406.5324721820425,8.999999999999998,9],[385.9592627733582,609.9126367040153,3,1],[208.72099326752505,658.5674895493721,3,1],[439.44174956211646,1218.344224392291,3,1],[388.2010084175454,748.2233402040147,4.242640687119285,2],[-15.701196017895805,488.495683669132,5.196152422706631,3],[348.44034488526813,2590.4578840450267,3,1],[358.4983812845603,2509.588635391585,3,1],[336.76422723985524,2761.126235235046,4.242640687119285,2],[419.23385340071763,755.8550537834672,4.242640687119285,2],[253.88292482902034,1918.3772256567026,3,1],[-78.25738569704117,481.1779133825621,3,1],[348.1848783654841,2886.358260495843,5.999999999999999,4],[295.7268177288449,3564.3125872317664,5.196152422706631,3],[297.4172481421507,3396.1206937442425,7.348469228349534,6],[305.72369947101834,3151.4906415917503,3,1],[302.1193899939939,3271.42333405146,9.949874371066198,11],[18.751257351665117,504.85588261589874,3,1],[387.4773055556652,991.9781865403929,3,1],[450.56726209959743,1360.9763909463654,3,1],[357.3561443051731,2492.2829790317337,3,1],[214.80574097279896,659.8844923036231,3,1],[-63.42157779304398,487.4842480044754,4.242640687119285,2],[311.1718707828986,3178.899836458586,3,1],[352.1136011921499,2700.5900287611476,8.48528137423857,8],[362.06250337970414,760.8582678947132,3,1],[328.77610833265317,1030.3770143500296,5.999999999999999,4],[-72.26126116121304,482.67736802232685,3,1],[395.74899187203846,751.0209878381575,3,1],[338.9462912616582,2724.201017398271,3,1],[340.0123237340522,3552.4761275683995,3,1],[298.95708329258923,3213.429950906284,3,1],[403.70115740925877,981.4311448968461,5.196152422706631,3],[284.70748331525346,2427.154061226669,5.196152422706631,3],[393.5643828391694,2044.470189010317,3,1],[338.22177416854174,1058.7606082852726,4.242640687119285,2],[451.2157923326449,1023.0454896461742,3,1],[320.4824586659379,3381.595540865208,4.242640687119285,2],[302.82188803193276,3202.6965989681776,3,1],[350.1567471958115,1095.8692169105634,3,1],[388.20908404964575,977.0818055485142,3,1],[395.3046203707102,985.8880436581579,5.196152422706631,3],[366.6360495498666,741.4074109695212,3,1],[337.8783949934441,2717.6155164118973,3,1],[323.8689115060115,2514.684656741214,3,1],[352.07818214231156,2508.7205841811374,4.242640687119285,2],[301.84782632779024,3176.4695429583226,4.242640687119285,2],[392.09030267172784,2051.7601896307024,3,1],[347.25272046127066,859.9922133480723,3,1],[432.94343016502273,891.2219263515955,11.224972160321823,14],[357.62742408693884,2627.7168859535886,3,1],[359.7025774376234,2604.6531763015373,3,1],[301.0699894690406,3624.936419600941,3,1],[344.5442684982081,2957.222558945541,5.999999999999999,4],[362.56830916526087,2553.8782593538344,3,1],[257.30732313765475,2822.047173743398,3,1],[178.2432148124244,652.7542792632594,4.242640687119285,2],[173.17699976026051,649.2231626735593,3,1],[295.31113172363257,3587.056716819294,3,1],[342.7636864949018,3000.254229516344,3,1],[362.35071880625765,2574.924896531418,3,1],[328.40871324794716,3296.8746701794444,3,1],[314.09218915387464,3165.273070601077,3,1],[293.7140486259159,3612.4661978636577,3,1],[287.4719002091515,2458.7091104469728,3,1],[335.89769436774077,2957.0235714747396,3,1],[373.3675831484652,846.3960157906113,3,1],[313.1437639224023,1037.6676846040355,3,1],[418.62871153214655,749.2162008950545,3,1],[418.5739214049754,767.6727607956273,3,1],[376.3295104214849,830.0601584741671,3,1],[317.4539926461148,3254.139975261438,3,1],[351.4761701233583,2778.9612464521197,3,1],[323.10683574235736,2740.3579783739406,3,1],[319.4144415931005,2701.6477689115854,3,1],[325.60926711156935,3404.748033604963,3,1],[367.18115077744733,850.1693352514121,3,1],[343.69372261061653,2707.8316856319143,3,1],[292.7422041460668,3556.095389962982,3,1],[317.6668013139206,3395.534386054147,3,1],[379.79953952957294,842.8308635897702,3,1],[452.2054120988978,1407.3924106137129,3,1],[323.5813209348489,2384.823953725543,3,1],[260.2985213129359,1946.300541976001,3,1],[321.4572837879241,2713.3449255232117,3,1],[333.20173574227374,2943.039621505013,3,1],[360.81223330271314,2592.9599857614667,3,1],[15.595937326573766,3215.302314801485,6.7082039324993685,5],[322.5844590070774,1035.6899000308476,3,1],[415.30305263945775,981.9777399618179,4.242640687119285,2],[185.05146318367042,655.1671264147444,3,1],[254.69781880525989,925.9039425018709,3,1],[346.66527005808894,2933.3334173265903,3,1],[301.3383261571362,3643.3694936085667,3,1],[339.740352028879,3053.861234464188,4.242640687119285,2],[341.15674257326464,3037.590499805854,4.242640687119285,2],[439.3391537825446,994.0264842088509,3,1],[350.40126189222184,1954.226130015168,7.348469228349534,6],[25.41888546156406,3212.208588407142,5.196152422706631,3],[363.5270862541268,601.628773160046,5.196152422706631,3],[364.0077314732116,609.8222696766024,3,1],[441.486283608072,882.9890457436559,3,1],[437.4668820950901,852.9480836233415,3,1],[429.54364818620525,853.1097415610275,3,1],[451.06742813535675,1122.578378520324,3,1],[435.2107990131335,1610.4525450062938,3,1],[435.81930010749056,836.536673070892,3,1],[66.58979186557553,3682.7053153990128,3,1],[62.890594658776536,3525.656494969997,3,1],[67.54934215843241,3892.802537185751,3,1],[42.573135706326866,3991.9115157652996,3,1],[35.54431831635884,3576.1055660040874,3,1]]
      }
    }
  }, 
  json: {}, dataSource: {}, el: {},
  init: function(whichMap) {
    coastMap.setStage(whichMap);
    coastMap.defineProjection();
    coastMap.appendSVGelements();
    coastMap.loadData();
    coastMap.util.initMiniMap();
    coastMap.util.initFixies();
    // coastMap.appendSources();
  },
  setStage: function(whichMap) {
    if      (whichMap == "ny") { 
      $(".interactive").addClass("ny")
      stageParameters = coastMap.v.ny; 
    }
    else if (whichMap == "nj") { 
      $(".interactive").addClass("nj")
      stageParameters = coastMap.v.nj; 
    }
      coastMap.v.width = stageParameters.width,
      coastMap.v.height = stageParameters.height,
      coastMap.v.translateX = stageParameters.translateX,
      coastMap.v.translateY = stageParameters.translateY,
      coastMap.v.center = stageParameters.center,
      coastMap.v.rotate = stageParameters.rotate,
      coastMap.v.scale = stageParameters.scale,

      coastMap.dataSource.coast = stageParameters.dataSource.coast,
      coastMap.dataSource.tracts = stageParameters.dataSource.tracts,
      coastMap.dataSource.damage = stageParameters.dataSource.damage,
      coastMap.dataSource.photos = stageParameters.dataSource.photos,
      coastMap.v.photosPath = stageParameters.dataSource.photosPath,
      coastMap.v.aggregateDamage = stageParameters.dataSource.aggregateDamage;

      $('#minMargin').append('<div class="sources">Data from FEMA and the U.S. Census Bureau. Aerial photos taken by the Civil Air Patrol. Income and unemployment numbers are estimates and can be subject to significant margins of error.</div>')
  },
  defineProjection: function() {
    coastMap.v.xy = d3.geo.albers();
    var xy = coastMap.v.xy;
    
    coastMap.v.path = d3.geo.path()
      .projection(xy)
      .pointRadius(2);

    xy.center(coastMap.v.center)
      .rotate(coastMap.v.rotate)
      .scale(coastMap.v.scale)
      .translate([coastMap.v.translateX, coastMap.v.translateY])
  },
  appendSVGelements: function() {
    coastMap.el.svg = d3.select("#pointPlot");

    coastMap.el.mapFrame = coastMap.el.svg
                            .append("g").attr("id","mapFrame");

    coastMap.el.choropleth = d3.select("#choropleth");

    coastMap.el.surgeLine = d3.select("#surgeLine");
    // coastMap.el.coast  = coastMap.el.mapFrame
    //                       .append("g").attr("id", "coast");

    coastMap.el.damage = coastMap.el.mapFrame
                          .append("g").attr("id", "damage");

    coastMap.el.photos = coastMap.el.mapFrame
                          .append("g").attr("id", "photos");
    
    coastMap.el.tracts = coastMap.el.choropleth
                          .append("g").attr("id","tracts");

    coastMap.el.tractEvents = d3.select("#tractEvents");

  },
  loadData: function() {
    // d3.json(coastMap.dataSource.coast,  coastMap.drawData.coast);
    d3.json(coastMap.dataSource.tracts, coastMap.drawData.tracts);
    d3.json(coastMap.dataSource.damage, coastMap.drawData.damage);
    d3.json(coastMap.dataSource.photos, coastMap.drawData.photos);
  },
  drawData: {
      tracts: function(json) {
      var tracts = coastMap.el.tracts,
          tractEvents = coastMap.el.tractEvents,
          xy = coastMap.v.xy,
          path = coastMap.v.path;

      tracts.append("rect").attr("class","tractBackground")
        .attr("height",coastMap.v.height)
        .attr('width',coastMap.v.width)

      tracts.selectAll("path")
          .data(json.features)
        .enter().append("path")
          .attr("d", path)
          .attr("class", function(d,i) { return coastMap.util.classBreaks(d) })

      tractEvents.selectAll("path") 
          .data(json.features)
        .enter().append("path")
          .attr("d", path)
          .on("mousemove",coastMap.events.tracts.move)
          .on("mouseout",coastMap.events.tracts.out)

      d3.selectAll(".toggle").on("click",coastMap.events.tracts.toggle); 
    },
    damage: function(json) {
      var damage = coastMap.el.damage,
          xy = coastMap.v.xy,
          path = coastMap.v.path,
          svg = coastMap.el.svg;
          
      coastMap.el.damageCircles = svg.append("g").attr("class","damageCircles")
      coastMap.el.damagePoints = svg.append("g").attr("class","damagePoints");
      
      var damageCircles = coastMap.el.damageCircles,
          damagePoints = coastMap.el.damagePoints;

      damagePoints.selectAll("path")
          .data(json.features)
      .enter().append("path")
        .attr("d", path)
        .attr("id",function(d,i){ return "pt-"+i; })

      damageCircles.selectAll("circle")
        .data(coastMap.v.aggregateDamage).enter()
      .append("circle")
        .attr("cx",function(d) { return d[0] })
        .attr("cy",function(d) { return d[1] })
        .attr("r",function(d)  { return d[2] })
        .on("mousemove",coastMap.events.damage.move)
        .on("mouseout",coastMap.events.damage.out)
    },
    photos: function(json) {
      var xy = coastMap.v.xy,
          path = coastMap.v.path;
          photos = coastMap.el.photos,
          photoDims = coastMap.v.photoDims;

      coastMap.json.photos = json;

      json.features.forEach(function(d) {
        var screenCoord = xy([d.properties.Longitude,d.properties.Latitude])
        d.properties.X = screenCoord[0];
        d.properties.Y = screenCoord[1];

        coastMap.v.photoLocations.push(screenCoord)
      });
      
      photos.append("g").attr("class","lineGroup")
        .selectAll("line").data(json.features)
        .enter().append("line");

      photos.append("g").attr("class","pointGroup")
        .selectAll("path").data(json.features)
        .enter().append("path")

      var lines  = d3.select(".lineGroup").selectAll("line"),  
          points = d3.select(".pointGroup").selectAll("path");

      lines
        .attr("class","photoLine")
        .attr("x1",function(d,i){ return d.properties.X })
        .attr("y1",function(d,i){ return Math.round(d.properties.Y) })
        .attr("x2",photoDims.x)
        .attr("y2",function(d,i){ return Math.round(d.properties.Y) })

      points
        .attr("d", path)
        .attr("class","photoLocation")
        .attr("id",function(d,i){ return "pt-"+i; })
        .classed("hidden", function(d,i) {
          if (d.properties.hide == 1) return true
            else return false
        })
      .append("title")
        .text(function(d,i) { return d.properties.Name; });

      var photoColumn = d3.select(".photoColumn").style("left",photoDims.x+"px"),
          photoPointer = d3.select(".photoPointer");

      photoColumn
        .on("mousemove", coastMap.events.photos.move)
        .on("mouseout", coastMap.events.photos.out);
    }
  },
  events: {
    tracts: {
      toggle: function() {
        var togs = d3.selectAll('.layerToggles'),
            surgeLine = coastMap.el.surgeLine,
            tracts = coastMap.el.tracts,
            tractEvents = coastMap.el.tractEvents,
            circles = coastMap.el.damageCircles,
            points = coastMap.el.damagePoints,

        clicked = $(this).hasClass('income') ? 'income' : 'unemp',
        other = clicked == 'income' ? 'unemp' : 'income';

        if (togs.classed(clicked)) {
          togs.classed(clicked,false);
          surgeLine.classed(clicked,false);
          tracts.classed(clicked,false);
          tractEvents.classed(clicked,false);
          circles.classed(clicked,false);
          points.classed(clicked,false);
        }
        else {
          togs.classed(clicked,true).classed(other,false);
          surgeLine.classed(clicked,true).classed(other,false);
          tracts.classed(clicked,true).classed(other,false);
          tractEvents.classed(clicked,true).classed(other,false);
          circles.classed(clicked,true).classed(other,false);
          points.classed(clicked,true).classed(other,false);
        }
      },
      move: function() {
        var m = d3.mouse(this),
            tractLabel = d3.select(".tractLabel");
   
        d3.select(this).each(function(d) {
          label = d3.select('#tracts').classed("income") ?
            "Median income:<br><strong>$"+coastMap.util.toDollars(d.properties.medIncome,0)+"</strong>" :
            "Percent unemployed:<br><strong>"+d.properties.pctUnemp+"%</strong>" ;
          
          tractLabel
            .style("left",m[0]+20+"px")
            .style("top",m[1]-20+"px")
            .html(label);
        });
      },
      out: function() {
        d3.select(".tractLabel")
          .style("left","-500px")
          .style("top","500px")
      },  
    },
    photos: {
      move: function() {
          var m = d3.mouse(this),
              json = coastMap.json.photos,
              dims = coastMap.v.photoDims,
              locs = coastMap.v.photoLocations,

              closestdistance = Number.MAX_VALUE,
              closestindex,
              closestproperties;

          for (var i=0;i<locs.length;i++){
            var l = locs[i][1]; // y coord of current point
            var d = Math.abs(m[1]-l)      // y-dist from mouse to point
            if (d<closestdistance) {
              closestindex = i;
              closestdistance = d;
            }
          }

          closestproperties = json.features[closestindex].properties
        
          d3.select(".photoPointer")
            .select("div")
            .style("top",closestproperties.Y-7 +"px")
            .style("display","inline");

          d3.selectAll(".photoLocation")
            .classed("closest",function(d,i) {
              return i == closestindex ? true : false;
            });

          d3.selectAll(".photoLine")
            .classed("closest",function(d,i) {
              return i == closestindex ? true : false;
            });
          
          var h = coastMap.v.height,
              pH = dims.h,
              pT = (m[1]-dims.h/2),
              pB = pT+pH,
              pad = 15,
              top = pT < pad   ? pad : 
                    pB > h-pad ? h-pH-pad :
                                 pT;

          //spritesheet
          var num = parseInt(closestproperties.fileNo,10)-1,
              yOffset = Math.floor(num/10)*dims.h, //(row number from 0 to n-1)
              xOffset = ((num%10)*dims.w);

          var photoBox = d3.select(".photoBox");

          photoBox
            .style("left",dims.l+"px")
            .style("top",top+"px")
            .style("display","inline")

          if (closestindex == coastMap.v.oldClosest) return;

          photoBox
            .style("background-position","-"+xOffset+"px -"+yOffset+"px")

          var dt = new Date(closestproperties.ImageCaptu);
              
              var dt_day = dt.toString("MMMM d")+dt.getOrdinal(),
              dt_time = dt.toString("h:mm tt")
          
          d3.select(".photoBox_link")
            .attr("href",coastMap.v.photosPath + closestproperties.Name)
            .attr("title","Image captured at "+dt_time+" on "+dt_day+".")

          coastMap.v.oldClosest = closestindex;
      },
      out: function() {
        d3.selectAll(".photoLocation").classed("closest",false);
        d3.selectAll(".photoLine").classed("closest",false);
        d3.select(".photoPointer").select("div").style("display","none");
        d3.select(".photoBox").style("display","none");
      },
      click: function() { }
    },
    damage: {
      move: function() {
        var m = d3.mouse(this),
            damageLabel = d3.select(".damageLabel");
   
        d3.select(this).each(function(d) {
          label = coastMap.util.getDamageLabel(d,m)

          damageLabel
            .style("left",label.x+"px")
            .style("top",label.y-(14/2)+"px")
        });
      },
      out: function() {
        d3.select(".damageLabel")
          .style("left","-500px")
          .style("top","500px")
      },   
    }
  },
  util: {
    classBreaks: function(d) {
      var incomeClass, unempClass;

      var incomeClass =
            d.properties.medIncome < 50000  ? 1 :
            d.properties.medIncome < 75000  ? 2 :
            d.properties.medIncome < 100000 ? 3 :
            d.properties.medIncome < 150000 ? 4 :
                                              5;

      var unempClass =
            d.properties.pctUnemp < 4  ? 1 :
            d.properties.pctUnemp < 7.5? 2 :
            d.properties.pctUnemp < 11 ? 3 :
            d.properties.pctUnemp < 15 ? 4 :
                                         5;
      return "i"+incomeClass+" u"+unempClass;      
    },
    getDamageLabel: function(d,m) {
      var v = d[3],
          r = d[2],
          dx = d[0],
          dy = d[1],
          mx = m[0],
          my = m[1],
          t = Math.abs(my-dy),
          halfchord = Math.sqrt(Math.pow(r,2)-Math.pow(t,2)),
          pad = r*0.8;

      pad = pad<10 ? 10 : pad;
      halfchord = isNaN(halfchord) ? 0 : halfchord;
      var Rx = dx+pad+(halfchord*0.33),
          Ry = my+3,
          Rl = v === 1 ? "<strong>"+v+" </strong>structure heavily damaged." :
                        "<strong>"+coastMap.util.toThousands(v)+" </strong>structures heavily damaged.";

      d3.select(".damageLabel").html(Rl)
      var lw = $('.damageLabel').width();
      Rx = (Rx+lw <= 740) ? Rx : 740-lw;

      var result = {
        x: Rx,
        y: Ry,
        text: Rl
      };

      return result;
    },
    toThousands: function(n) {
      var sRegExp = new RegExp('(-?[0-9]+)([0-9]{3})'), sValue=n+'', sep = ',';
      while(sRegExp.test(sValue)) { sValue = sValue.replace(sRegExp, '$1'+sep+'$2'); }
      return sValue;
    },
    toDollars: function(n, c, d, t){
      // from http://stackoverflow.com/questions/149055/how-can-i-format-numbers-as-money-in-javascript
      var n = isNaN(n = Math.abs(n)) ? 0 : n, 
          c = isNaN(c = Math.abs(c)) ? 2 : c, 
          d = d == undefined ? "." : d, 
          t = t == undefined ? "," : t, 
          s = n < 0 ? "-" : "", 
          i = parseInt(n = Math.abs(+n || 0).toFixed(c)) + "", 
          j = (j = i.length) > 3 ? j % 3 : 0;

      return s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");
    },
    initMiniMap: function() {
      $(window).bind("scroll", function() {
        var windowScroll = $(this).scrollTop(),
            offset = windowScroll-$('#interactive').offset().top,
            h = $(window).height();

        var $miniMap = $('#miniMap'),
            $miniMapHighlight = $('#miniMap div'),
            isVisible = $miniMap.css('display') == 'none' ? false : true;

        $miniMap.css('left',$('#interactive').offset().left-95+'px')

        if (windowScroll < 100) { $miniMap.fadeOut('slow') }
        if (windowScroll >= 100) { $miniMap.fadeIn('slow'); }
       
        if (windowScroll < 280) { $miniMap.css({ 'top' : -offset + 'px' }); }
        else { 
          $miniMap.css('top','20px');
          $miniMap.css('display','inline');
        }

        $miniMapHighlight.css({
          'top': offset/10+'px',
          'height': h/10+'px'
        });

        //var drag = d3.behavior.drag().on("drag", dragmove);
        //d3.select('#miniMap div').call(drag);
        //function dragmove(d) { 
        //var pos = $miniMapHighlight.position().top*10,
        //    y = d3.event.y-10,
        //    highlightHeight = $miniMapHighlight.height(),
        //    miniMapHeight = $miniMap.height(),
        //    top = y <= -2  ? -2 : 
        //          y+highlightHeight >= miniMapHeight ? miniMapHeight-highlightHeight : y;

        //  d3.select(this).style('top', top+'px');
        //  window.scroll(0, pos+300);
        //}
      });
    },
    initFixies: function() {
      var photoAnnotOffset = $("#photoAnnot").offset(),
          $photoAnnotClone = $("#photoAnnot > *").clone(),
          $photoAnnotFixed = $("#fixed-photoAnnot").append($photoAnnotClone),

          layerTogglesOffset = $("#layerToggles").offset(),
          $layerTogglesClone = $("#layerToggles > *").clone(),
          $layerTogglesFixed = $("#fixed-layerToggles").append($layerTogglesClone);


      $(window).bind("scroll", function() {
        var offset = $(this).scrollTop();

        if (offset >= photoAnnotOffset.top && $photoAnnotFixed.is(":hidden")) {
            $("#photoAnnot").hide();
            $photoAnnotFixed.show();
        }
        else if (offset < photoAnnotOffset.top) {
            $photoAnnotFixed.hide(); $("#photoAnnot").show();
        }

        if (offset >= layerTogglesOffset.top && $layerTogglesFixed.is(":hidden")) {
            $("#layerToggles").hide();
            $layerTogglesFixed.show();
        }
        else if (offset < layerTogglesOffset.top) {
            $layerTogglesFixed.hide(); $("#layerToggles").show();
        }

        $photoAnnotFixed.css('left',$('#photoColumn').offset().left+1+'px')
        $layerTogglesFixed.css('left',$('#photoColumn').offset().left-150+"px")
		
      });    
    }
  }
}